<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Check-in - Earnzy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="assets/style.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="px-4 py-3">
                <div class="flex justify-between items-center">
                    <a href="dashboard.html" class="text-gray-600 flex items-center">
                        ‚Üê Back
                    </a>
                    <h1 class="text-xl font-bold text-gray-800">Daily Check-in</h1>
                    <div class="w-6"></div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="content-with-nav p-4">
            <!-- Stats Card -->
            <div class="card-app mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">Daily Check-in Streak</h2>
                        <p class="text-gray-600 text-sm">Check in daily to build your streak</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">Current Streak</p>
                        <p class="text-2xl font-bold text-green-600" id="currentStreak">0</p>
                        <p class="text-xs text-gray-500">days</p>
                    </div>
                </div>
            </div>

            <!-- Check-in Status -->
            <div class="card-app text-center mb-6">
                <div class="w-20 h-20 bg-green-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl text-green-600" id="checkinIcon">üìÖ</span>
                </div>
                <h3 class="text-xl font-bold mb-2" id="checkinTitle">Daily Check-in</h3>
                <p class="text-gray-600 mb-4" id="checkinDescription">Check in today to continue your streak</p>
                <button id="checkinBtn" class="btn-app mb-3">
                    Check In Today
                </button>
                <p class="text-sm text-gray-500" id="todayReward">Today's reward: <span class="font-bold">10 coins</span></p>
            </div>

            <!-- Streak Calendar -->
            <div class="card-app mb-6">
                <h3 class="text-lg font-bold mb-4">7-Day Streak Bonus</h3>
                <div class="grid grid-cols-7 gap-2">
                    <div class="text-center p-2 bg-green-50 rounded-xl border-2 border-green-200">
                        <p class="text-xs font-medium">Day 1</p>
                        <p class="text-green-700 font-bold text-sm">10</p>
                    </div>
                    <div class="text-center p-2 bg-green-50 rounded-xl border-2 border-green-200">
                        <p class="text-xs font-medium">Day 2</p>
                        <p class="text-green-700 font-bold text-sm">20</p>
                    </div>
                    <div class="text-center p-2 bg-green-50 rounded-xl border-2 border-green-200">
                        <p class="text-xs font-medium">Day 3</p>
                        <p class="text-green-700 font-bold text-sm">30</p>
                    </div>
                    <div class="text-center p-2 bg-green-50 rounded-xl border-2 border-green-200">
                        <p class="text-xs font-medium">Day 4</p>
                        <p class="text-green-700 font-bold text-sm">40</p>
                    </div>
                    <div class="text-center p-2 bg-green-50 rounded-xl border-2 border-green-200">
                        <p class="text-xs font-medium">Day 5</p>
                        <p class="text-green-700 font-bold text-sm">50</p>
                    </div>
                    <div class="text-center p-2 bg-green-50 rounded-xl border-2 border-green-200">
                        <p class="text-xs font-medium">Day 6</p>
                        <p class="text-green-700 font-bold text-sm">75</p>
                    </div>
                    <div class="text-center p-2 bg-yellow-50 rounded-xl border-2 border-yellow-200">
                        <p class="text-xs font-medium">Day 7</p>
                        <p class="text-yellow-700 font-bold text-sm">100</p>
                    </div>
                </div>
                <p class="text-center text-gray-600 text-sm mt-4">Complete 7 days to earn 100 coins bonus!</p>
            </div>

            <!-- Check-in History -->
            <div class="card-app">
                <h3 class="text-lg font-bold mb-4">Recent Check-ins</h3>
                <div id="checkinHistory" class="space-y-3">
                    <div class="text-center text-gray-500 py-4">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-2">
                            <span class="text-gray-400">üìä</span>
                        </div>
                        <p>No check-in history yet</p>
                        <p class="text-sm">Check in today to start your streak</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="dashboard.html" class="nav-item">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">Home</span>
            </a>
            <a href="watch.html" class="nav-item">
                <span class="nav-icon">üé•</span>
                <span class="nav-label">Watch</span>
            </a>
            <a href="checkin.html" class="nav-item active">
                <span class="nav-icon">üìÖ</span>
                <span class="nav-label">Check-in</span>
            </a>
            <a href="withdraw.html" class="nav-item">
                <span class="nav-icon">üí∏</span>
                <span class="nav-label">Cash</span>
            </a>
        </nav>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-2xl p-8 mx-4 max-w-sm w-full text-center slide-up">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-2xl text-green-600">‚úÖ</span>
            </div>
            <h3 class="text-xl font-bold mb-2">Check-in Successful!</h3>
            <p class="text-gray-600 mb-2">Daily streak updated</p>
            <p class="text-2xl font-bold text-green-600 mb-2" id="streakReward">+10 coins</p>
            <p class="text-sm text-gray-500 mb-6">New streak: <span id="newStreakCount" class="font-bold">1 day</span></p>
            <button id="closeModal" class="btn-app">Continue</button>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://qwoqpwyjugfsiwlwvmlf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3b3Fwd3lqdWdmc2l3bHd2bWxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzkzNDAsImV4cCI6MjA3NTA1NTM0MH0.36cfavBebNeF4SLuar3jUTRORYnhaOhc6A5xuF4HvLw';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        let userId = null;
        let currentStreak = 0;
        let todayCheckedIn = false;
        
        // Check authentication
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                window.location.href = 'login.html';
            } else {
                userId = session.user.id;
                loadCheckinStatus();
                loadCheckinHistory();
            }
        });
        
        // Load check-in status
        async function loadCheckinStatus() {
            try {
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('daily_streak, last_checkin')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                
                currentStreak = userData.daily_streak || 0;
                document.getElementById('currentStreak').textContent = currentStreak;
                
                const today = new Date().toISOString().split('T')[0];
                const lastCheckin = userData.last_checkin;
                
                // Check if user already checked in today
                if (lastCheckin === today) {
                    todayCheckedIn = true;
                    updateCheckinUI(true);
                } else {
                    // Check if streak should be reset (missed a day)
                    if (lastCheckin) {
                        const lastCheckinDate = new Date(lastCheckin);
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        
                        if (lastCheckinDate.toDateString() !== yesterday.toDateString() && 
                            lastCheckinDate.toDateString() !== new Date().toDateString()) {
                            // Reset streak
                            await supabase
                                .from('users')
                                .update({ daily_streak: 0 })
                                .eq('id', userId);
                            currentStreak = 0;
                            document.getElementById('currentStreak').textContent = currentStreak;
                        }
                    }
                    
                    updateCheckinUI(false);
                }
                
            } catch (error) {
                console.error('Error loading check-in status:', error);
            }
        }
        
        // Update check-in UI based on status
        function updateCheckinUI(alreadyCheckedIn) {
            const icon = document.getElementById('checkinIcon');
            const title = document.getElementById('checkinTitle');
            const description = document.getElementById('checkinDescription');
            const button = document.getElementById('checkinBtn');
            const rewardText = document.getElementById('todayReward');
            
            // Calculate today's reward based on streak
            const rewards = [10, 20, 30, 40, 50, 75, 100];
            const todayReward = rewards[Math.min(currentStreak, 6)];
            
            if (alreadyCheckedIn) {
                icon.textContent = '‚úÖ';
                title.textContent = 'Already Checked In';
                description.textContent = `You've already checked in today. Come back tomorrow!`;
                button.textContent = 'Already Checked In';
                button.disabled = true;
                button.className = 'btn-app bg-gray-400 cursor-not-allowed';
                rewardText.innerHTML = `Today's reward: <span class="font-bold">${todayReward} coins</span> (claimed)`;
            } else {
                icon.textContent = 'üìÖ';
                title.textContent = 'Daily Check-in';
                description.textContent = `Check in today to continue your ${currentStreak}-day streak`;
                button.textContent = 'Check In Today';
                button.disabled = false;
                button.className = 'btn-app';
                rewardText.innerHTML = `Today's reward: <span class="font-bold">${todayReward} coins</span>`;
            }
        }
        
        // Check-in button handler
        document.getElementById('checkinBtn').addEventListener('click', async () => {
            if (todayCheckedIn) return;
            
            const button = document.getElementById('checkinBtn');
            button.disabled = true;
            button.textContent = 'Checking In...';
            button.classList.add('loading');
            
            try {
                // Calculate reward based on streak
                const rewards = [10, 20, 30, 40, 50, 75, 100];
                const coins = rewards[Math.min(currentStreak, 6)];
                const newStreak = currentStreak + 1;
                const today = new Date().toISOString().split('T')[0];
                
                // Add earning record
                const { data, error } = await supabase
                    .from('earnings')
                    .insert([
                        { 
                            user_id: userId,
                            type: 'checkin',
                            coins: coins
                        }
                    ]);
                
                if (error) throw error;
                
                // Update user's streak and coins
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('total_coins, earned_coins')
                    .eq('id', userId)
                    .single();
                
                if (userError) throw userError;
                
                await supabase
                    .from('users')
                    .update({
                        total_coins: userData.total_coins + coins,
                        earned_coins: userData.earned_coins + coins,
                        daily_streak: newStreak,
                        last_checkin: today
                    })
                    .eq('id', userId);
                
                // Show success modal
                document.getElementById('streakReward').textContent = `+${coins} coins`;
                document.getElementById('newStreakCount').textContent = `${newStreak} day${newStreak > 1 ? 's' : ''}`;
                document.getElementById('successModal').classList.remove('hidden');
                
                // Update UI
                todayCheckedIn = true;
                currentStreak = newStreak;
                document.getElementById('currentStreak').textContent = currentStreak;
                updateCheckinUI(true);
                
                // Reload history
                loadCheckinHistory();
                
            } catch (error) {
                console.error('Error recording check-in:', error);
                alert('Error recording your check-in. Please try again.');
            } finally {
                button.disabled = false;
                button.textContent = 'Check In Today';
                button.classList.remove('loading');
            }
        });
        
        // Load check-in history
        async function loadCheckinHistory() {
            try {
                const { data, error } = await supabase
                    .from('earnings')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('type', 'checkin')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                const historyContainer = document.getElementById('checkinHistory');
                historyContainer.innerHTML = '';
                
                if (data.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center text-gray-500 py-4">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                <span class="text-gray-400">üìä</span>
                            </div>
                            <p>No check-in history yet</p>
                            <p class="text-sm">Check in today to start your streak</p>
                        </div>
                    `;
                    return;
                }
                
                data.forEach(earning => {
                    const earningElement = document.createElement('div');
                    earningElement.className = 'flex justify-between items-center py-3 border-b border-gray-100';
                    
                    const date = new Date(earning.created_at);
                    const dateString = date.toLocaleDateString();
                    
                    earningElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center mr-3">
                                <span class="text-green-600">üìÖ</span>
                            </div>
                            <div>
                                <div class="font-medium">Daily Check-in</div>
                                <div class="text-sm text-gray-500">${dateString}</div>
                            </div>
                        </div>
                        <div class="font-bold text-green-600">+${earning.coins}</div>
                    `;
                    
                    historyContainer.appendChild(earningElement);
                });
            } catch (error) {
                console.error('Error loading check-in history:', error);
            }
        }
        
        // Close modal
        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('successModal').classList.add('hidden');
        });
    </script>
</body>
</html>
